# ระบบตรวจสอบและอัปเดตสถานะเอกสารอัตโนมัติ

## ภาพรวม

ระบบจะตรวจสอบและอัปเดตสถานะเอกสารเป็น "พ้นกำหนด" อัตโนมัติเมื่อเลยวันที่กำหนดแล้ว

## การทำงาน

### 1. การตรวจสอบใบแจ้งหนี้ (Invoice)

- **เงื่อนไข**: ใบแจ้งหนี้ที่มีสถานะ "รอชำระ" หรือ "ชำระบางส่วน" และวันที่ครบกำหนดชำระ (`due_date`) น้อยกว่าวันที่ปัจจุบัน
- **การอัปเดต**: เปลี่ยนสถานะเป็น "พ้นกำหนด"

### 2. การตรวจสอบใบเสนอราคา (Quotation)

- **เงื่อนไข**: ใบเสนอราคาที่มีสถานะ "รอตอบรับ" และวันที่หมดอายุ (`valid_until`) น้อยกว่าวันที่ปัจจุบัน
- **การอัปเดต**: เปลี่ยนสถานะเป็น "พ้นกำหนด"

## การเรียกใช้

ระบบจะตรวจสอบและอัปเดตสถานะเอกสารในกรณีต่อไปนี้:

1. **เมื่อดึงข้อมูลเอกสารทั้งหมด** (`GET /api/documents`)
2. **เมื่อดึงข้อมูลเอกสารตาม ID** (`GET /api/documents/:id`)

## ฟังก์ชันที่ใช้

### `checkAndUpdateDocumentStatus(pool)`

ฟังก์ชันที่ทำการตรวจสอบและอัปเดตสถานะเอกสาร

```typescript
async function checkAndUpdateDocumentStatus(pool: any) {
  const today = new Date().toISOString().slice(0, 10);

  try {
    // อัปเดตสถานะใบแจ้งหนี้ที่พ้นกำหนดชำระ
    await pool.query(
      `
      UPDATE documents d
      INNER JOIN invoice_details id ON d.id = id.document_id
      SET d.status = 'พ้นกำหนด'
      WHERE d.document_type = 'INVOICE' 
        AND d.status IN ('รอชำระ', 'ชำระบางส่วน')
        AND id.due_date < ?
    `,
      [today]
    );

    // อัปเดตสถานะใบเสนอราคาที่พ้นกำหนด
    await pool.query(
      `
      UPDATE documents d
      INNER JOIN quotation_details qd ON d.id = qd.document_id
      SET d.status = 'พ้นกำหนด'
      WHERE d.document_type = 'QUOTATION' 
        AND d.status = 'รอตอบรับ'
        AND qd.valid_until < ?
    `,
      [today]
    );

    console.log(
      `[${new Date().toISOString()}] Document status check completed`
    );
  } catch (err) {
    console.error("Failed to check and update document status:", err);
  }
}
```

## สถานะที่รองรับ

### ใบแจ้งหนี้ (Invoice)

- **ร่าง** - ใบแจ้งหนี้ที่ยังไม่เสร็จสมบูรณ์
- **รอชำระ** - ใบแจ้งหนี้ที่รอการชำระเงิน
- **ชำระแล้ว** - ใบแจ้งหนี้ที่ชำระเงินแล้ว
- **ชำระบางส่วน** - ใบแจ้งหนี้ที่ชำระเงินมาแล้วแต่ยังไม่ครบจำนวน
- **พ้นกำหนด** - ใบแจ้งหนี้ที่พ้นกำหนดชำระ
- **ยกเลิก** - ใบแจ้งหนี้ที่ถูกยกเลิก

### ใบเสนอราคา (Quotation)

- **ร่าง** - ใบเสนอราคาที่ยังไม่เสร็จสมบูรณ์
- **รอตอบรับ** - ใบเสนอราคาที่รอการตอบรับ
- **ตอบรับแล้ว** - ใบเสนอราคาที่ได้รับการตอบรับ
- **พ้นกำหนด** - ใบเสนอราคาที่พ้นกำหนด
- **ยกเลิก** - ใบเสนอราคาที่ถูกยกเลิก

## การแสดงผล

### Frontend

- **สีแดง** สำหรับสถานะ "พ้นกำหนด" ในตารางรายการเอกสาร
- **ตัวเลือกสถานะ** "พ้นกำหนด" ในฟอร์มแก้ไขเอกสาร
- **การกรอง** สามารถกรองเอกสารตามสถานะ "พ้นกำหนด" ได้

### Backend

- **การบันทึก** สถานะ "พ้นกำหนด" ในฐานข้อมูล
- **การตรวจสอบ** อัตโนมัติเมื่อดึงข้อมูลเอกสาร

## ไฟล์ที่เปลี่ยนแปลง

### Backend

1. `backend/server.ts`
   - เพิ่มฟังก์ชัน `checkAndUpdateDocumentStatus()`
   - เพิ่มการเรียกใช้ฟังก์ชันใน API endpoints

### Frontend

1. `src/pages/documents/Invoice.tsx`

   - เพิ่มการแสดงสถานะ "พ้นกำหนด" ใน `getStatusBadge()`
   - เพิ่มตัวเลือก "พ้นกำหนด" ใน `statusOptions`

2. `src/pages/documents/Quotation.tsx`

   - เพิ่มการแสดงสถานะ "พ้นกำหนด" ใน `getStatusBadge()`
   - เพิ่มตัวเลือก "พ้นกำหนด" ใน `statusOptions`

3. `src/pages/sub/create/DocumentForm.tsx`
   - เพิ่มตัวเลือก "พ้นกำหนด" ในฟอร์มแก้ไขเอกสาร

## การทดสอบ

1. สร้างใบแจ้งหนี้หรือใบเสนอราคาที่มีวันที่ครบกำหนดในอดีต
2. ตรวจสอบว่าสถานะเปลี่ยนเป็น "พ้นกำหนด" อัตโนมัติ
3. ตรวจสอบการแสดงผลในหน้า frontend

## หมายเหตุ

- การตรวจสอบจะทำงานทุกครั้งที่ดึงข้อมูลเอกสาร
- ระบบจะบันทึก log เมื่อตรวจสอบเสร็จสิ้น
- หากเกิดข้อผิดพลาดในการอัปเดต จะบันทึก error log แต่ไม่หยุดการทำงานของระบบ
