# การอัปเดตสถานะใบเสร็จและใบแจ้งหนี้

## การเปลี่ยนแปลง

### เพิ่มสถานะ "ร่าง" ให้ใบเสร็จและใบแจ้งหนี้

ได้เพิ่มสถานะ "ร่าง" ให้กับใบเสร็จและใบแจ้งหนี้เพื่อให้สอดคล้องกับ workflow การทำงานของระบบ

### เอกสารที่สร้างอัตโนมัติจะมีสถานะ "ร่าง"

เมื่อมีการสร้างเอกสารอัตโนมัติ เอกสารที่สร้างขึ้นจะมีสถานะเป็น "ร่าง" แทนที่จะเป็นสถานะสุดท้าย

### ข้อมูลการชำระเงินจะถูกบันทึกใน receipt_details

ข้อมูลการชำระเงินทั้งหมดจะถูกบันทึกในตาราง `receipt_details` รวมถึง:

- ช่องทางการชำระเงิน (payment_channels)
- ค่าธรรมเนียม (fees)
- เอกสารหักลบ (offset_docs)
- ยอดสุทธิที่รับชำระ (net_total_receipt)

### สถานะจะอัปเดตอัตโนมัติตามยอดที่ชำระ

สถานะของใบเสร็จจะอัปเดตอัตโนมัติตามยอดที่ชำระ:

- **ร่าง**: ยังไม่มีการชำระเงิน
- **ชำระบางส่วน**: ชำระเงินมาแล้วแต่ยังไม่ครบจำนวน
- **ชำระแล้ว**: ชำระเงินครบถ้วนแล้ว

## สถานะที่ใช้

### ใบเสร็จ (Receipt)

- **ร่าง** - ใบเสร็จที่ยังไม่เสร็จสมบูรณ์
- **ชำระแล้ว** - ใบเสร็จที่ชำระเงินครบถ้วนแล้ว
- **ชำระบางส่วน** - ใบเสร็จที่ชำระเงินมาแล้วแต่ยังไม่ครบจำนวน
- **ยกเลิก** - ใบเสร็จที่ถูกยกเลิก

### ใบแจ้งหนี้ (Invoice)

- **ร่าง** - ใบแจ้งหนี้ที่ยังไม่เสร็จสมบูรณ์
- **รอชำระ** - ใบแจ้งหนี้ที่รอการชำระเงิน
- **ชำระแล้ว** - ใบแจ้งหนี้ที่ชำระเงินแล้ว
- **พ้นกำหนด** - ใบแจ้งหนี้ที่พ้นกำหนดชำระ
- **ยกเลิก** - ใบแจ้งหนี้ที่ถูกยกเลิก

## ไฟล์ที่เปลี่ยนแปลง

### Frontend

1. `src/pages/documents/Receipt.tsx`
   - เพิ่มสถานะ "ร่าง" และ "ชำระบางส่วน" ใน `getStatusBadge()`
   - เพิ่มตัวเลือก "ร่าง" และ "ชำระบางส่วน" ใน `statusOptions`

2. `src/pages/sub/receipt/ReceiptForm.tsx`
   - เปลี่ยนสถานะเริ่มต้นจาก "ชำระแล้ว" เป็น "ร่าง"

3. `src/pages/sub/create/DocumentForm.tsx`
   - เปลี่ยนสถานะเริ่มต้นจาก "draft" เป็น "ร่าง"
   - เพิ่มตัวเลือกสถานะ "ร่าง" และ "ชำระบางส่วน" สำหรับใบเสร็จและใบแจ้งหนี้

4. `src/App.tsx`
   - เปลี่ยนสถานะของใบเสร็จที่สร้างอัตโนมัติจาก "ต้นฉบับ" เป็น "ร่าง"

### Backend

1. `backend/schema.sql`
   - เพิ่ม "ร่าง" และ "ชำระบางส่วน" ใน enum status ของตาราง documents

2. `backend/add_draft_status.sql` (ใหม่)
   - Migration script สำหรับอัปเดตฐานข้อมูลที่มีอยู่

3. `backend/server.ts`
   - เปลี่ยนสถานะของใบแจ้งหนี้ที่สร้างอัตโนมัติจาก "รอชำระ" เป็น "ร่าง"
   - เปลี่ยนสถานะของใบเสร็จที่สร้างอัตโนมัติจาก "ชำระแล้ว" เป็น "ร่าง"
   - เพิ่มการบันทึกข้อมูล payment_channels, fees, offset_docs ใน receipt_details
   - เพิ่มการสร้างรายการกระแสเงินสดอัตโนมัติ
   - แก้ไขเงื่อนไขการบันทึก receipt_details ให้บันทึกทุกใบเสร็จ (ไม่ต้องมี payment_date และ payment_method)

4. `backend/fix_missing_receipt_details.sql` (ใหม่)
   - Migration script สำหรับเพิ่มข้อมูล receipt_details สำหรับใบเสร็จที่มีอยู่แล้ว

## การใช้งาน

### สำหรับผู้ใช้

1. เมื่อสร้างใบเสร็จใหม่ สถานะจะเริ่มต้นเป็น "ร่าง"
2. เมื่อสร้างใบแจ้งหนี้ใหม่ สถานะจะเริ่มต้นเป็น "ร่าง"
3. เมื่อใบเสนอราคาถูกตอบรับ จะสร้างใบแจ้งหนี้อัตโนมัติด้วยสถานะ "ร่าง"
4. เมื่อใบแจ้งหนี้ถูกชำระ จะสร้างใบเสร็จอัตโนมัติด้วยสถานะ "ร่าง"
5. สถานะของใบเสร็จจะอัปเดตอัตโนมัติตามยอดที่ชำระ:
   - **ร่าง**: ยังไม่มีการชำระเงิน
   - **ชำระบางส่วน**: ชำระเงินมาแล้วแต่ยังไม่ครบจำนวน
   - **ชำระแล้ว**: ชำระเงินครบถ้วนแล้ว
6. ข้อมูลการชำระเงินทั้งหมดจะถูกบันทึกในฐานข้อมูล
7. สามารถยกเลิกเอกสารได้โดยเปลี่ยนสถานะเป็น "ยกเลิก"

### สำหรับ Developer

1. รัน migration script: `mysql -u username -p database_name < backend/add_draft_status.sql`
2. รัน migration script สำหรับแก้ไขข้อมูลที่หายไป: `mysql -u username -p database_name < backend/fix_missing_receipt_details.sql`
3. ตรวจสอบว่าสถานะ "ร่าง" แสดงผลถูกต้องในหน้าใบเสร็จและใบแจ้งหนี้
4. ตรวจสอบว่าข้อมูล receipt_details ถูกบันทึกครบถ้วน

## ประโยชน์

1. **ป้องกันข้อผิดพลาด**: เอกสารที่ยังไม่เสร็จสมบูรณ์จะมีสถานะร่าง
2. **สอดคล้องกับ workflow**: ผู้ใช้สามารถสร้างเอกสารแบบร่างไว้ก่อน
3. **สอดคล้องกับเอกสารอื่นๆ**: เอกสารประเภทอื่นๆ ก็มีสถานะที่แสดงถึงการยังไม่เสร็จสมบูรณ์
4. **ควบคุมการสร้างเอกสารอัตโนมัติ**: เอกสารที่สร้างอัตโนมัติจะเริ่มต้นด้วยสถานะร่าง ให้ผู้ใช้ตรวจสอบก่อนยืนยัน
